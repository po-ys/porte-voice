<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>ポルテ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/jpg" href="porte3.png" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#000000" />

  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
      background-color: black;
    }

    video {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 100vw;
      max-height: 100vh;
      object-fit: contain;
      z-index: 0;
      background-color: black;
    }

    .footer {
      position: absolute;
      bottom: 5%;
      width: 100%;
      text-align: center;
      color: white;
      text-shadow: 0 0 10px black;
      z-index: 10;
    }

    button {
      font-size: 1.2em;
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      cursor: pointer;
    }

    .hidden {
      display: none;
    }

    p {
      margin-top: 10px;
      font-size: 0.9em;
    }

    #log {
      display: none;
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 5px 10px;
      font-size: 0.8em;
      border-radius: 5px;
      max-width: 90%;
      word-break: break-word;
      z-index: 10;
    }
  </style>
</head>

<body>

  <!-- 動画 -->
  <video id="p1-video" src="p1.mp4" playsinline muted preload="auto"></video>
  <video id="p1rev-video" src="p1rev.mp4" playsinline muted preload="auto" style="display: none;"></video>
  <video id="p3-video" src="p3.mp4" playsinline muted preload="auto" style="display: none;"></video>
  <video id="p4-video" src="p4.mp4" playsinline muted preload="auto" style="display: none;"></video>
  <video id="p5-video" src="p5.mp4" playsinline muted preload="auto" style="display: none;"></video>
  <video id="p6-video" src="p6.mp4" playsinline muted preload="auto" style="display: none;"></video>
  <video id="p7-video" src="p7.mp4" playsinline muted preload="auto" style="display: none;"></video>
  <video id="p8-video" src="p8.mp4" playsinline muted preload="auto" style="display: none;"></video>

  <!-- UI -->
  <div class="footer">
    <button id="start-btn">▶ スタート</button>
    <p id="start-msg">※最初に1回だけボタンを押してください。</p>
  </div>
  <div id="log">音声認識待機中...</div>

  <script>
    const btn = document.getElementById("start-btn");
    const msg = document.getElementById("start-msg");

    const p1Video = document.getElementById("p1-video");
    const p1revVideo = document.getElementById("p1rev-video");
    const p3Video = document.getElementById("p3-video");
    const p4Video = document.getElementById("p4-video");
    const p5Video = document.getElementById("p5-video");
    const p6Video = document.getElementById("p6-video");
    const p7Video = document.getElementById("p7-video");
    const p8Video = document.getElementById("p8-video");

    let p2Video = null;
    let isWaitingForReply = false;
    let replyTimeoutId = null;

    function stopAllVideos() {
      [p1Video, p1revVideo, p3Video, p4Video, p5Video, p6Video, p7Video, p8Video, p2Video].forEach(v => {
        if (v) {
          v.pause();
          v.currentTime = 0;
          v.style.display = "none";
          v.muted = true;
        }
      });
    }

    function startWaitTimeout() {
      isWaitingForReply = true;
      if (replyTimeoutId) clearTimeout(replyTimeoutId);
      replyTimeoutId = setTimeout(() => {
        if (isWaitingForReply) {
          console.log("待機中に該当ワードなし → p1rev.mp4 再生");
          isWaitingForReply = false;
          stopAllVideos();
          p1revVideo.style.display = "block";
          p1revVideo.currentTime = 0;
          p1revVideo.play().catch(e => console.error("p1rev 再生エラー:", e));
        }
      }, 3000);
    }

    [p1Video, p3Video, p4Video, p5Video, p6Video, p7Video, p8Video].forEach(video => {
      video.addEventListener("ended", () => {
        console.log(video.id + " 終了、3秒待機開始");
        startWaitTimeout();
      });
    });

    function createAndPlayP2Video() {
      if (!p2Video) {
        p2Video = document.createElement("video");
        p2Video.id = "p2-video";
        p2Video.src = "p2.mp4";
        p2Video.playsInline = true;
        p2Video.muted = true;
        p2Video.preload = "auto";
        p2Video.style.position = "fixed";
        p2Video.style.top = "50%";
        p2Video.style.left = "50%";
        p2Video.style.transform = "translate(-50%, -50%)";
        p2Video.style.maxWidth = "100vw";
        p2Video.style.maxHeight = "100vh";
        p2Video.style.objectFit = "contain";
        p2Video.style.zIndex = "0";
        p2Video.style.display = "none";
        document.body.appendChild(p2Video);

        p2Video.addEventListener("ended", () => {
          console.log("p2.mp4 終了、3秒待機開始");
          startWaitTimeout();
        });
      }

      stopAllVideos();
      p2Video.style.display = "block";
      p2Video.currentTime = 0;

      p2Video.play().then(() => {
        p2Video.muted = false;
      }).catch(e => {
        console.error("p2 再生エラー:", e);
      });
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
      alert("このブラウザは音声認識に対応していません。");
    } else {
      const recognition = new SpeechRecognition();
      recognition.lang = 'ja-JP';
      recognition.continuous = true;
      recognition.interimResults = false;

      let isListening = false;
      let lastHeard = Date.now();

      const keywords1 = ["ぽるて", "ぽーちゃん", "ぽおちゃん", "ぽーちやん", "こうちゃん", "父ちゃん", "ふぉるて", "フォルテ"];
      const replyKeywords = ["返事は", "へんじは", "ヘンジハ", "お返事は", "おへんじは", "オヘンジハ"];
      const secondReplyKeywords = ["もう一回", "もういっかい", "モウイッカイ", "もう1回"];
      const kawaiiKeywords = ["かわいい", "可愛い", "カワイイ", "かわいいね", "可愛いね", "カワイイネ"];
      const rikouKeywords = ["りこう", "利口", "リコウ", "おりこう", "お利口", "オリコウ"];
      const sanpoKeywords = ["さんぽ", "散歩", "サンポ", "おさんぽ", "お散歩", "オサンポ"];
      const oyatsuKeywords = ["おやつ", "オヤツ"];
      const tanoshiiKeywords = ["たのしい", "楽しい", "タノシイ"];

      recognition.onresult = (event) => {
        const rawTranscript = event.results[event.results.length - 1][0].transcript.trim();
        console.log("認識結果:", rawTranscript);
        lastHeard = Date.now();

        const normalizedTranscript = rawTranscript
          .replace(/[ァ-ン]/g, s => String.fromCharCode(s.charCodeAt(0) - 0x60))
          .replace(/\s/g, '')
          .toLowerCase();

        if (isWaitingForReply) {
          clearTimeout(replyTimeoutId);
          startWaitTimeout();

          const checks = [
            { keywords: replyKeywords, video: p3Video, label: "返事", id: "p3" },
            { keywords: secondReplyKeywords, action: createAndPlayP2Video, label: "もう一回" },
            { keywords: kawaiiKeywords, video: p4Video, label: "かわいい", id: "p4" },
            { keywords: rikouKeywords, video: p5Video, label: "りこう", id: "p5" },
            { keywords: sanpoKeywords, video: p6Video, label: "さんぽ", id: "p6" },
            { keywords: oyatsuKeywords, video: p7Video, label: "おやつ", id: "p7" },
            { keywords: tanoshiiKeywords, video: p8Video, label: "たのしい", id: "p8" }
          ];

          for (const check of checks) {
            if (check.keywords?.some(w => rawTranscript.includes(w)) || check.keywords?.some(w => normalizedTranscript.includes(w))) {
              console.log(`${check.label}ワード認識 → ${check.id || "p2"}.mp4 再生`);
              isWaitingForReply = false;
              clearTimeout(replyTimeoutId);
              stopAllVideos();
              if (check.video) {
                check.video.style.display = "block";
                check.video.currentTime = 0;
                check.video.play().catch(e => console.error(`${check.id} 再生エラー:`, e));
              } else if (check.action) {
                check.action();
              }
              return;
            }
          }

          return;
        }

        const matchVideo =
          keywords1.some(word => normalizedTranscript.includes(word)) ||
          keywords1.some(word => rawTranscript.includes(word)) ||
          (normalizedTranscript.includes("ぽ") && normalizedTranscript.includes("ちゃん"));

        if (matchVideo) {
          console.log("マッチ: p1.mp4（ぽるて系）");
          stopAllVideos();
          p1Video.style.display = "block";
          p1Video.currentTime = 0;
          p1Video.play().catch(e => console.error("p1 再生エラー:", e));
        } else {
          console.log("マッチなし");
        }
      };

      recognition.onerror = (event) => {
        console.error("認識エラー:", event.error);
      };

      recognition.onend = () => {
        console.log("認識終了。再起動します...");
        setTimeout(() => {
          recognition.start();
        }, 1000);
      };

      setInterval(() => {
        const now = Date.now();
        if (isListening && now - lastHeard > 15000) {
          console.log("無音状態が続いたため音声認識を再起動します");
          recognition.stop();
        }
      }, 5000);

      btn.addEventListener("click", () => {
        recognition.start();
        isListening = true;
        btn.classList.add("hidden");
        msg.classList.add("hidden");
        console.log("音声認識開始");
        p1Video.pause();
        p1Video.currentTime = 0;
      });

      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js')
            .then(registration => {
              console.log('Service Worker 登録成功:', registration.scope);
            })
            .catch(error => {
              console.error('Service Worker 登録失敗:', error);
            });
        });
      }
    }
  </script>

</body>

</html>
