<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ポルテ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: sans-serif;
    }
    video {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      object-fit: cover; z-index: -1;
    }
    .footer {
      position: absolute; bottom: 5%; width: 100%; text-align: center;
      color: white; text-shadow: 0 0 10px black;
    }
    button {
      font-size: 1.2em; padding: 10px 20px;
      border: none; border-radius: 10px;
      background-color: rgba(0, 0, 0, 0.6);
      color: white; cursor: pointer;
    }
    .hidden { display: none; }
    p { margin-top: 10px; font-size: 0.9em; }

    /* logを非表示にする */
    #log {
      display: none;
      position: absolute; top: 10px; left: 10px;
      background: rgba(0,0,0,0.6); color: white;
      padding: 5px 10px; font-size: 0.8em;
      border-radius: 5px; max-width: 90%;
      word-break: break-word;
    }
  </style>
</head>
<body>

  <!-- 動画 -->
  <video id="p1-video" src="p1.mp4" playsinline muted></video>
  <video id="p1rev-video" src="p1rev.mp4" playsinline style="display: none;"></video>
  <video id="p3-video" src="p3.mp4" playsinline style="display: none;"></video>
  <video id="p4-video" src="p4.mp4" playsinline style="display: none;"></video>

  <!-- UI -->
  <div class="footer">
    <button id="start-btn">▶ スタート</button>
    <p id="start-msg">※最初に1回だけボタンを押してください。</p>
  </div>
  <div id="log">音声認識待機中...</div>

  <script>
    const btn = document.getElementById("start-btn");
    const msg = document.getElementById("start-msg");
    const log = document.getElementById("log");

    const p1Video = document.getElementById("p1-video");
    const p1revVideo = document.getElementById("p1rev-video");
    const p3Video = document.getElementById("p3-video");
    const p4Video = document.getElementById("p4-video");

    let isWaitingForReply = false;
    let replyTimeoutId = null;

    function stopAllVideos() {
      [p1Video, p1revVideo, p3Video, p4Video].forEach(v => {
        v.pause();
        v.currentTime = 0;
        v.style.display = "none";
      });
    }

    p1Video.addEventListener("loadeddata", () => {
      p1Video.pause();
      p1Video.currentTime = 0;
    });

    p1Video.addEventListener("ended", () => {
      console.log("p1.mp4 終了、5秒待機中にワードチェック");
      isWaitingForReply = true;

      replyTimeoutId = setTimeout(() => {
        if (isWaitingForReply) {
          console.log("該当ワード認識されず → p1rev.mp4 再生");
          isWaitingForReply = false;
          stopAllVideos();
          p1revVideo.style.display = "block";
          p1revVideo.currentTime = 0;
          p1revVideo.play().catch(e => console.error("逆再生エラー:", e));
        }
      }, 5000);
    });

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
      alert("このブラウザは音声認識に対応していません。");
    } else {
      const recognition = new SpeechRecognition();
      recognition.lang = 'ja-JP';
      recognition.continuous = true;
      recognition.interimResults = false;

      let isListening = false;
      let lastHeard = Date.now();

      const keywords1 = [
        "ぽるて", "ぽーちゃん", "ぽおちゃん", "ぽーちやん",
        "こうちゃん", "父ちゃん", "ふぉるて", "フォルテ"
      ];

      const replyKeywords = ["返事は", "へんじは", "ヘンジハ", "お返事は", "おへんじは", "オヘンジハ"];
      const kawaiiKeywords = ["かわいい", "可愛い", "カワイイ", "かわいいね", "可愛いいね", "カワイイネ"];

      recognition.onresult = (event) => {
        const rawTranscript = event.results[event.results.length - 1][0].transcript.trim();
        log.innerText = `認識：${rawTranscript}`;
        console.log("元の認識文字列:", rawTranscript);
        lastHeard = Date.now();

        const normalizedTranscript = rawTranscript
          .replace(/[ァ-ン]/g, s => String.fromCharCode(s.charCodeAt(0) - 0x60))
          .replace(/\s/g, '')
          .toLowerCase();

        if (isWaitingForReply) {
          const isReply = replyKeywords.some(word => rawTranscript.includes(word)) ||
                          normalizedTranscript.includes("へんじは") || normalizedTranscript.includes("おへんじは");
          const isKawaii = kawaiiKeywords.some(word => rawTranscript.includes(word)) ||
                           normalizedTranscript.includes("かわいい") || normalizedTranscript.includes("かわいいね");

          if (isKawaii) {
            console.log("かわいいワード認識 → p4.mp4 再生");
            isWaitingForReply = false;
            clearTimeout(replyTimeoutId);
            stopAllVideos();
            p4Video.style.display = "block";
            p4Video.currentTime = 0;
            p4Video.play().catch(e => console.error("p4 再生エラー:", e));
            return;
          } else if (isReply) {
            console.log("返事ワード認識 → p3.mp4 再生");
            isWaitingForReply = false;
            clearTimeout(replyTimeoutId);
            stopAllVideos();
            p3Video.style.display = "block";
            p3Video.currentTime = 0;
            p3Video.play().catch(e => console.error("p3 再生エラー:", e));
            return;
          }
        }

        if (!isWaitingForReply) {
          const matchVideo =
            keywords1.some(word => normalizedTranscript.includes(word)) ||
            keywords1.some(word => rawTranscript.includes(word)) ||
            (normalizedTranscript.includes("ぽ") && normalizedTranscript.includes("ちゃん"));

          if (matchVideo) {
            console.log("マッチ: p1.mp4（ぽるて系）");
            stopAllVideos();
            p1Video.style.display = "block";
            p1Video.currentTime = 0;
            p1Video.play().catch(e => console.error("p1 再生エラー:", e));
          } else {
            console.log("マッチなし");
          }
        }
      };

      recognition.onerror = (event) => {
        console.error("認識エラー:", event.error);
      };

      recognition.onend = () => {
        console.log("認識終了。再起動します...");
        setTimeout(() => {
          recognition.start();
        }, 500);
      };

      setInterval(() => {
        const now = Date.now();
        if (isListening && now - lastHeard > 15000) {
          console.log("無音状態が続いたため音声認識を再起動します");
          recognition.stop();
        }
      }, 5000);

      btn.addEventListener("click", () => {
        recognition.start();
        isListening = true;
        btn.classList.add("hidden");
        msg.classList.add("hidden");
        log.innerText = "音声認識を開始しました。";
        console.log("音声認識開始");
        p1Video.pause();
        p1Video.currentTime = 0;
      });
    }
  </script>
</body>
</html>
