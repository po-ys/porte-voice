<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒãƒ«ãƒ†15</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/jpg" href="porte3.png" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#000000" />

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
      background-color: black;
    }
    video {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 100vw;
      max-height: 100vh;
      object-fit: contain;
      z-index: 0;
      background-color: black;
      display: none;
    }
    #p1-video { display: block; }
    .footer {
      position: absolute;
      bottom: 5%;
      width: 100%;
      text-align: center;
      color: white;
      text-shadow: 0 0 10px black;
      z-index: 10;
    }
    button {
      font-size: 1.2em;
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      background-color: rgba(0,0,0,0.6);
      color: white;
      cursor: pointer;
      min-width: 140px;
      min-height: 44px;
    }
    .hidden { display: none; }
    p { margin-top: 10px; font-size: 0.9em; line-height: 1.4em; }
    #log {
      display: block;
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 5px 10px;
      font-size: 0.8em;
      border-radius: 5px;
      max-width: 90%;
      word-break: break-word;
      z-index: 10;
      white-space: pre-line;
    }
    #static-image {
      position: fixed;
      top:50%;
      left:50%;
      transform: translate(-50%, -50%);
      max-width:100vw;
      max-height:100vh;
      z-index:0;
      display:none;
    }
  </style>
</head>
<body>

<img id="static-image" src="porte1.png" alt="é™æ­¢ç”»">

<video id="p1-video" src="p1.mp4" playsinline muted preload="metadata"></video>
<video id="p1rev-video" src="p1rev.mp4" playsinline muted preload="metadata"></video>
<video id="p2-video" src="p2.mp4" playsinline muted preload="auto"></video>
<video id="p3-video" src="p3.mp4" playsinline muted preload="auto"></video>
<video id="p4-video" src="p4.mp4" playsinline muted preload="metadata"></video>
<video id="p5-video" src="p5.mp4" playsinline muted preload="metadata"></video>
<video id="p6-video" src="p6.mp4" playsinline muted preload="metadata"></video>
<video id="p7-video" src="p7.mp4" playsinline muted preload="metadata"></video>
<video id="p8-video" src="p8.mp4" playsinline muted preload="metadata"></video>
<video id="p9-video" src="p9.mp4" playsinline muted preload="metadata"></video>
<video id="p10-video" src="10.mp4" playsinline muted preload="metadata" loop></video>
<video id="p11-video" src="p11.mp4" playsinline muted preload="metadata"></video>
<video id="p12-video" src="p12.mp4" playsinline muted preload="metadata"></video>

<div class="footer">
  <button id="start-btn">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  <p id="start-msg">â€»æœ€åˆã«1å›ã ã‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
</div>
<div id="log">éŸ³å£°èªè­˜å¾…æ©Ÿä¸­...
ç¾åœ¨å†ç”Ÿ: é™æ­¢ç”»</div>

<script>
const btn = document.getElementById("start-btn");
const msg = document.getElementById("start-msg");
const log = document.getElementById("log");
const staticImg = document.getElementById("static-image");

const videos = {
  p1: document.getElementById("p1-video"),
  p1rev: document.getElementById("p1rev-video"),
  p2: document.getElementById("p2-video"),
  p3: document.getElementById("p3-video"),
  p4: document.getElementById("p4-video"),
  p5: document.getElementById("p5-video"),
  p6: document.getElementById("p6-video"),
  p7: document.getElementById("p7-video"),
  p8: document.getElementById("p8-video"),
  p9: document.getElementById("p9-video"),
  p10: document.getElementById("p10-video"),
  p11: document.getElementById("p11-video"),
  p12: document.getElementById("p12-video")
};

let isListening = false;
let lastHeard = Date.now();
let playedP1 = false;
let playingP1rev = false;
let waitingKeywords = true;
let logLines = ["éŸ³å£°èªè­˜å¾…æ©Ÿä¸­...", "ç¾åœ¨å†ç”Ÿ: é™æ­¢ç”»"];

function updateLog(newLine){
  logLines.unshift(newLine);
  if(logLines.length>2) logLines.pop();
  log.textContent = logLines.join("\n");
}

async function switchVideo(newVideo){
  try{
    staticImg.style.display = "none";
    newVideo.style.display = "block";

    if(newVideo.id==="p2-video" || newVideo.id==="p3-video"){
      newVideo.muted = false;
      newVideo.volume = 1.0;
    } else {
      newVideo.muted = true;
      newVideo.volume = 0;
    }

    newVideo.currentTime = 0;
    newVideo.load(); // ç¢ºå®Ÿã«ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°

    await newVideo.play().catch(async e=>{
      console.warn(newVideo.id+" play rejected, retrying...", e);
      await new Promise(r=>setTimeout(r,300));
      await newVideo.play().catch(e2=>console.error(newVideo.id+" retry failed:", e2));
    });

    Object.values(videos).forEach(v=>{
      if(v !== newVideo){
        v.pause();
        v.style.display = "none";
        v.currentTime = 0;
        v.muted = true;
        v.volume = 0;
      }
    });

    playingP1rev = newVideo.id==="p1rev-video";
    updateLog("ç¾åœ¨å†ç”Ÿ: "+newVideo.src.split('/').pop());
  }catch(e){ console.error("switchVideo error:", e); }
}

function setupEndListeners(){
  ['p1','p2','p3','p4','p5','p6','p7','p8','p9','p11','p12'].forEach(key=>{
    videos[key].addEventListener('ended', ()=>{ switchVideo(videos.p10); });
  });
  videos.p1rev.addEventListener('ended', ()=>{
    staticImg.style.display="block";
    waitingKeywords=true;
  });
}
setupEndListeners();

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if(!SpeechRecognition){ alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚") }
else{
  const recognition = new SpeechRecognition();
  recognition.lang='ja-JP';
  recognition.continuous=true;
  recognition.interimResults=false;

  const keywords1 = /(ã½ã‚‹ã¦|ã½ãƒ¼ã¡ã‚ƒã‚“|ã½ãŠã¡ã‚ƒã‚“|ã½ãƒ¼ã¡ã‚„ã‚“|ã“ã†ã¡ã‚ƒã‚“|çˆ¶ã¡ã‚ƒã‚“|ãµã‰ã‚‹ã¦|ãƒ•ã‚©ãƒ«ãƒ†|æ¥ã‚Œã¦|ã“ã‚Œã¦|å–ã‚Œã¦|ã¨ã‚Œã¦|é™ã‚Šã¦|ãŠã‚Šã¦)/i;
  const replyKeywords = /(è¿”äº‹|ã¸ã‚“ã˜|ãŠè¿”äº‹|ãŠã¸ã‚“ã˜)/i;
  const secondReplyKeywords = /(ã‚‚ã†ä¸€å›|ã‚‚ã†ã„ã£ã‹ã„|ã‚‚ã†1å›)/i;
  const kawaiiKeywords = /(ã‹ã‚ã„ã„|å¯æ„›ã„)/i;
  const sugoiKeywords = /(ã™ã”ã„|å‡„ã„)/i;
  const rikouKeywords = /(ã‚Šã“ã†|åˆ©å£)/i;
  const sanpoKeywords = /(ã•ã‚“ã½|æ•£æ­©)/i;
  const oyatsuKeywords = /(ãŠã‚„ã¤)/i;
  const tanoshiiKeywords = /(ãŸã®ã—ã„|æ¥½ã—ã„)/i;
  const byeKeywords = /(ã¾ãŸã­|ãŠã‚„ã™ã¿)/i;
  const oteKeywords = /(ãŠã¦|ãŠæ‰‹|å¤§æ‰‹)/i;
  const chuKeywords = /(ã¡ã‚…ã†|ã¡ã‚…ãƒ¼|ä¸­|ã¡ã‚…|ãƒãƒ¥ãƒ¼|ãƒãƒ¥|ä¸­å’Œ)/i;

  recognition.onresult = async (event)=>{
    const rawTranscript = event.results[event.results.length-1][0].transcript.trim();
    updateLog("èªè­˜çµæœ: "+rawTranscript);
    lastHeard=Date.now();
    const normalizedTranscript = rawTranscript.replace(/ãƒ¼/g,'').replace(/[ã‚¡-ãƒ³]/g,s=>String.fromCharCode(s.charCodeAt(0)-0x60)).replace(/\s/g,'').toLowerCase();

    if(waitingKeywords){
      if(keywords1.test(rawTranscript) || keywords1.test(normalizedTranscript)){
        await switchVideo(videos.p1);
        waitingKeywords=false;
        playedP1=true;
      }
      return;
    }

    if(playingP1rev && waitingKeywords){
      if(keywords1.test(rawTranscript) || keywords1.test(normalizedTranscript)){
        await switchVideo(videos.p1);
        playingP1rev=false;
        waitingKeywords=false;
        playedP1=true;
      }
      return;
    }

    if(!playedP1){
      if(keywords1.test(rawTranscript) || keywords1.test(normalizedTranscript)){
        playedP1=true;
        await switchVideo(videos.p1);
      }
      return;
    } else {
      if(keywords1.test(rawTranscript) || keywords1.test(normalizedTranscript)){ await switchVideo(videos.p3); return; }
      if(oteKeywords.test(rawTranscript)||oteKeywords.test(normalizedTranscript)){ await switchVideo(videos.p9); return; }
      if(byeKeywords.test(rawTranscript)||byeKeywords.test(normalizedTranscript)){ await switchVideo(videos.p1rev); playingP1rev=true; return; }
      if(replyKeywords.test(rawTranscript)||replyKeywords.test(normalizedTranscript)){ await switchVideo(videos.p3); return; }
      if(secondReplyKeywords.test(rawTranscript)||secondReplyKeywords.test(normalizedTranscript)){ await switchVideo(videos.p2); playingP1rev=false; return; }
      if(kawaiiKeywords.test(rawTranscript)||kawaiiKeywords.test(normalizedTranscript)|| sugoiKeywords.test(rawTranscript)|| sugoiKeywords.test(normalizedTranscript)|| rikouKeywords.test(rawTranscript)|| rikouKeywords.test(normalizedTranscript)){ await switchVideo(videos.p4); return; }
      if(sanpoKeywords.test(rawTranscript)||sanpoKeywords.test(normalizedTranscript)|| oyatsuKeywords.test(rawTranscript)||oyatsuKeywords.test(normalizedTranscript)){ await switchVideo(videos.p12); return; }
      if(tanoshiiKeywords.test(rawTranscript)||tanoshiiKeywords.test(normalizedTranscript)){ await switchVideo(videos.p11); return; }
      if(chuKeywords.test(rawTranscript)||chuKeywords.test(normalizedTranscript)){ await switchVideo(videos.p5); return; }
    }
  };

  recognition.onerror = (event)=>{ updateLog("èªè­˜ã‚¨ãƒ©ãƒ¼: "+event.error); };
  recognition.onend = ()=>{ if(isListening) setTimeout(()=>recognition.start(),500); };

  btn.addEventListener("click", async ()=>{
    recognition.start();
    isListening=true;
    playedP1=false;
    playingP1rev=false;
    waitingKeywords=true;
    btn.classList.add("hidden");
    msg.classList.add("hidden");
    updateLog("éŸ³å£°èªè­˜é–‹å§‹");

    // ğŸ”½ Androidå‘ã‘ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—å‡¦ç†ï¼ˆç”»é¢éè¡¨ç¤ºï¼‰
    for (let src of ["p2.mp4","p3.mp4"]) {
      let v = document.createElement("video");
      v.src = src;
      v.preload = "auto";
      v.muted = true;
      v.playsinline = true;
      v.style.display = "none";
      document.body.appendChild(v);

      try {
        await v.play();
        setTimeout(()=>{ 
          v.pause(); 
          v.currentTime = 0; 
          v.remove(); 
        }, 200);
      } catch(e) {
        console.warn("warmup failed:", src, e);
      }
    }
  });

  document.addEventListener('dblclick', ()=>{
    const elem = document.documentElement;
    if(!document.fullscreenElement){
      elem.requestFullscreen?.();
    } else {
      document.exitFullscreen?.();
    }
  });

  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('sw.js').then(reg=>console.log('Service Worker ç™»éŒ²æˆåŠŸ:',reg.scope)).catch(e=>console.error('Service Worker ç™»éŒ²å¤±æ•—:',e));
    });
  }
}
</script>

</body>
</html>
