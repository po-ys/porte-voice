<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>ポルテ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/jpg" href="porte3.png" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#000000" />

  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
      background-color: black;
    }

    video {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 100vw;
      max-height: 100vh;
      object-fit: contain;
      z-index: 0;
      background-color: black;
      display: none;
    }

    .footer {
      position: absolute;
      top: 10%;
      width: 100%;
      text-align: center;
      color: white;
      text-shadow: 0 0 10px black;
      z-index: 10;
    }

    button {
      font-size: 1.2em;
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      background-color: rgba(0, 0, 0, 0.6);
      color: white;
      cursor: pointer;
      min-width: 140px;
      min-height: 44px;
    }

    .hidden {
      display: none;
    }

    p {
      margin-top: 10px;
      font-size: 0.9em;
      line-height: 1.4em;
    }

    #log {
      display: none;
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 5px 10px;
      font-size: 0.8em;
      border-radius: 5px;
      max-width: 90%;
      word-break: break-word;
      z-index: 10;
      white-space: pre-line;
    }

    #static-image {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 100vw;
      max-height: 100vh;
      z-index: 0;
      display: block;
    }

    #p2-image,
    #p4-image {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 100vw;
      max-height: 100vh;
      z-index: 2;
      display: none;
      pointer-events: none;
    }
  </style>
</head>

<body>

  <img id="static-image" src="porte1.png" alt="静止画">
  <img id="p2-image" src="porte2.png" alt="無効ワード" />
  <img id="p4-image" src="porte4.png" alt="porte4" />

  <video id="p1-video" src="p1.mp4" playsinline muted preload="metadata"></video>
  <video id="p1rev-video" src="p1rev.mp4" playsinline muted preload="metadata"></video>
  <video id="p2-video" src="p2.mp4" playsinline muted preload="metadata"></video>
  <video id="p3-video" src="p3.mp4" playsinline muted preload="metadata"></video>
  <video id="p4-video" src="p4.mp4" playsinline muted preload="metadata"></video>
  <video id="p5-video" src="p5.mp4" playsinline muted preload="metadata"></video>
  <video id="p6-video" src="p6.mp4" playsinline muted preload="metadata"></video>
  <video id="p7-video" src="p7.mp4" playsinline muted preload="metadata"></video>
  <video id="p8-video" src="p8.mp4" playsinline muted preload="metadata"></video>
  <video id="p9-video" src="p9.mp4" playsinline muted preload="metadata"></video>
  <video id="p10-video" src="p10.mp4" playsinline muted preload="metadata" loop></video>
  <video id="p11-video" src="p11.mp4" playsinline muted preload="metadata"></video>
  <video id="p12-video" src="p12.mp4" playsinline muted preload="metadata"></video>
  <video id="p13-video" src="p13.mp4" playsinline muted preload="metadata"></video>
  <video id="p14-video" src="p14.mp4" playsinline muted preload="metadata"></video>
  <video id="p15-video" src="p15.mp4" playsinline muted preload="metadata"></video>
  <video id="p16-video" src="p16.mp4" playsinline muted preload="metadata"></video>
  <video id="p17-video" src="p17.mp4" playsinline muted preload="metadata"></video>
  <video id="p18-video" src="p18.mp4" playsinline muted preload="metadata"></video>
  <video id="p19-video" src="p19.mp4" playsinline muted preload="metadata"></video>
  <video id="p20-video" src="p20.mp4" playsinline muted preload="metadata"></video>
  <video id="p21-video" src="p21.mp4" playsinline muted preload="metadata"></video>
  <video id="p22-video" src="p22.mp4" playsinline muted preload="metadata"></video>
  <video id="p23-video" src="p23.mp4" playsinline muted preload="metadata"></video>
  <video id="p24-video" src="p24.mp4" playsinline muted preload="metadata"></video>
  <video id="p25-video" src="p25.mp4" playsinline muted preload="metadata"></video>
  <video id="p26-video" src="p26.mp4" playsinline muted preload="metadata"></video>

  <div class="footer">
    <button id="start-btn">▶ ポルテ おこしてね</button>
  </div>
  <div id="log">音声認識待機中...
    現在再生: 静止画</div>

  <script>
    const btn = document.getElementById("start-btn");
    const log = document.getElementById("log");
    const staticImg = document.getElementById("static-image");
    const p2Img = document.getElementById("p2-image");
    const p4Img = document.getElementById("p4-image");

    const videos = {
      p1: document.getElementById("p1-video"),
      p1rev: document.getElementById("p1rev-video"),
      p2: document.getElementById("p2-video"),
      p3: document.getElementById("p3-video"),
      p4: document.getElementById("p4-video"),
      p5: document.getElementById("p5-video"),
      p6: document.getElementById("p6-video"),
      p7: document.getElementById("p7-video"),
      p8: document.getElementById("p8-video"),
      p9: document.getElementById("p9-video"),
      p10: document.getElementById("p10-video"),
      p11: document.getElementById("p11-video"),
      p12: document.getElementById("p12-video"),
      p13: document.getElementById("p13-video"),
      p14: document.getElementById("p14-video"),
      p15: document.getElementById("p15-video"),
      p16: document.getElementById("p16-video"),
      p17: document.getElementById("p17-video"),
      p18: document.getElementById("p18-video"),
      p19: document.getElementById("p19-video"),
      p20: document.getElementById("p20-video"),
      p21: document.getElementById("p21-video"),
      p22: document.getElementById("p22-video"),
      p23: document.getElementById("p23-video"),
      p24: document.getElementById("p24-video"),
      p25: document.getElementById("p25-video"),
      p26: document.getElementById("p26-video")
    };

    let isListening = false;
    let playedP1 = false;
    let waitingKeywords = true;
    let playingP1rev = false;
    let recognition = null;
    let recognitionRetryInterval = null;

    // 動画切り替えの最適化版
    async function switchVideo(newVideo, triggeredBy = null) {
      try {
        // 1. 他の動画を停止し、非表示にする
        Object.keys(videos).forEach(key => {
          const v = videos[key];
          if (v !== newVideo) {
            v.pause();
            v.style.display = "none";
            v.muted = true;
          }
        });

        // 2. 静止画や一時画像の非表示
        staticImg.style.display = "none";
        p2Img.style.display = "none";
        p4Img.style.display = "none";

        // 3. 新しい動画の準備
        newVideo.style.display = "block";
        
        // p2, p3 の場合のみ音声を出す設定
        if (newVideo.id === "p2-video" || newVideo.id === "p3-video") {
          newVideo.muted = false;
          newVideo.volume = 1.0;
        } else {
          newVideo.muted = true;
          newVideo.volume = 0;
        }

        newVideo.currentTime = 0;

        // 4. ブラウザの描画タイミングに合わせて再生を開始（フリーズ対策）
        requestAnimationFrame(async () => {
          try {
            await newVideo.play();
          } catch (e) {
            console.warn("再生がブロックされました:", e);
          }
        });

        playingP1rev = (newVideo.id === "p1rev-video");
      } catch (e) {
        console.error("switchVideo error:", e);
      }
    }

    function setupEndListeners() {
      Object.keys(videos).forEach(key => {
        if (key === 'p1rev' || key === 'p10') return;
        videos[key].addEventListener('ended', () => {
          switchVideo(videos.p10);
        });
      });

      videos.p1rev.addEventListener('ended', () => {
        staticImg.style.display = "block";
        waitingKeywords = true;
        playingP1rev = false;
      });
    }
    setupEndListeners();

    function initRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("このブラウザは音声認識に対応していません。");
        return;
      }
      recognition = new SpeechRecognition();
      recognition.lang = 'ja-JP';
      recognition.continuous = true;
      recognition.interimResults = false;

      // キーワード定義
      const keywords1 = /(ぽるて|ポルテ|ぽーちゃん|ぽおちゃん|ぽうちゃん|ポーちゃん|おーちゃん|フォーちゃん|こうちゃん|父ちゃん|ふぉるて|フォルテ|来れて|これて|取れて|とれて|降りて|おりて|ポチャン|ぽちゃん)/i;
      const replyKeywords = /(返事|へんじ|お返事|おへんじ)/i;
      const secondReplyKeywords = /(もう一回|もういっかい|もう1回)/i;
      const kawaiiKeywords = /(かわいい|可愛い)/i;
      const sugoiKeywords = /(すごい|凄い)/i;
      const rikouKeywords = /(りこう|利口|お利口|おりこう)/i;
      const sanpoKeywords = /(さんぽ|散歩|お散歩|おさんぽ)/i;
      const oyatsuKeywords = /(おやつ)/i;
      const tanoshiiKeywords = /(たのしい|楽しい|楽しかったね|おいしい|美味しい)/i;
      const byeKeywords = /(またね|おやすみ|じゃあね|じゃーね)/i;
      const oteKeywords = /(おて|お手|大手|おては|お手は|大手は)/i;
      const chuKeywords = /(ちゅう|ちゅー|チュー|チュ|注|中|おはよう|おはよー)/i;
      const iineKeywords = /(いいね|イイネー|いいねー|いいねえ|イイねえ|イイね)/i;
      const genkiKeywords = /(元気|げんき|ゲンキ)/i;
      const gomenKeywords = /(ごめん|ゴメン|ごめんよ|ゴメンよ)/i;
      const sukiKeywords = /(好き|すき|スキ)/i;
      const arigatoKeywords = /(ありがとう|ありがと)/i;
      const dekakeKeywords = /(でかけ|出かけ|おでかけ|お出かけ)/i;
      const doushimasuKeywords = /(どうしますか|どおしますか|どーしますか)/i;
      const iiKeywords = /(いいでしょ|いいでしょう|いいで)/i;
      const douzoKeywords = /(どうぞ|食べて|たべて)/i;
      const choudaiKeywords = /(ちょうだい|頂戴)/i;
      const kamatteKeywords = /(かまって|構って|あそんで|遊んで|あそぶの|遊ぶの)/i;
      const ikunoKeywords = /(いくの|行くの|たべるの|食べるの|食べんの|たべんの|いきたい|行きたい|食べたい|たべたい)/i;
      const nakayoshiKeywords = /(なかよし|仲良し)/i;
      const doushitaKeywords = /(どうした|どうしたの)/i;
      const dameKeywords = /(だめ|ダメ|駄目)/i;
      const oshikkoKeywords = /(おしっこ|オシッコ)/i;
      const mizuKeywords = /(みず|水|おみず|お水)/i;
      const unchiKeywords = /(うんち|ウンチ)/i;
      const dakkoKeywords = /(だっこ|ダッコ|抱っこ)/i;
      const okawariKeywords = /(おかわり)/i;
      const kiteKeywords = /(きて|来て|着て)/i;
      const oideKeywords = /(おいで)/i;
      const okiteKeywords = /(おきて)/i;
      const hashiruKeywords = /(はしる|走る)/i;
      const jumpKeywords = /(じゃんぷ|ジャンプ)/i;

      function isTrivialUtterance(text, confidence) {
        const t = (text || "").trim();
        if (!t) return true;
        if (t.replace(/[ \u3000]/g, '').length < 2) return true;
        if (typeof confidence === 'number' && confidence < 0.2) return true;
        return false;
      }

      recognition.onresult = async (event) => {
        const res = event.results[event.results.length - 1][0];
        const rawTranscript = (res.transcript || "").trim();
        const conf = typeof res.confidence === 'number' ? res.confidence : 1;
        if (isTrivialUtterance(rawTranscript, conf)) return;

        const normalizedTranscript = rawTranscript
          .replace(/ー/g, '')
          .replace(/[ァ-ン]/g, s => String.fromCharCode(s.charCodeAt(0) - 0x60))
          .replace(/\s/g, '')
          .toLowerCase();

        let matched = false;
        const isP10Visible = (videos.p10.style.display === 'block');

        if (waitingKeywords) {
          if (keywords1.test(rawTranscript) || keywords1.test(normalizedTranscript)) {
            await switchVideo(videos.p1, rawTranscript);
            waitingKeywords = false;
            playedP1 = true;
            matched = true;
          }
        } else {
          if (keywords1.test(rawTranscript) || keywords1.test(normalizedTranscript)) { await switchVideo(videos.p3, rawTranscript); matched = true; }
          else if (oteKeywords.test(rawTranscript) || oteKeywords.test(normalizedTranscript)) { await switchVideo(videos.p9, rawTranscript); matched = true; }
          else if (byeKeywords.test(rawTranscript) || byeKeywords.test(normalizedTranscript)) { await switchVideo(videos.p1rev, rawTranscript); playingP1rev = true; matched = true; }
          else if (replyKeywords.test(rawTranscript) || replyKeywords.test(normalizedTranscript)) { await switchVideo(videos.p3, rawTranscript); matched = true; }
          else if (secondReplyKeywords.test(rawTranscript) || secondReplyKeywords.test(normalizedTranscript)) { await switchVideo(videos.p2, rawTranscript); matched = true; }
          else if (kawaiiKeywords.test(rawTranscript) || kawaiiKeywords.test(normalizedTranscript)) { await switchVideo(videos.p13, rawTranscript); matched = true; }
          else if (nakayoshiKeywords.test(rawTranscript) || nakayoshiKeywords.test(normalizedTranscript)) { await switchVideo(videos.p14, rawTranscript); matched = true; }
          else if (doushitaKeywords.test(rawTranscript) || doushitaKeywords.test(normalizedTranscript)) { await switchVideo(videos.p15, rawTranscript); matched = true; }
          else if (dameKeywords.test(rawTranscript) || dameKeywords.test(normalizedTranscript)) { await switchVideo(videos.p16, rawTranscript); matched = true; }
          else if (oshikkoKeywords.test(rawTranscript) || oshikkoKeywords.test(normalizedTranscript)) { await switchVideo(videos.p17, rawTranscript); matched = true; }
          else if (mizuKeywords.test(rawTranscript) || mizuKeywords.test(normalizedTranscript)) { await switchVideo(videos.p18, rawTranscript); matched = true; }
          else if (unchiKeywords.test(rawTranscript) || unchiKeywords.test(normalizedTranscript)) { await switchVideo(videos.p19, rawTranscript); matched = true; }
          else if (dakkoKeywords.test(rawTranscript) || dakkoKeywords.test(normalizedTranscript)) { await switchVideo(videos.p20, rawTranscript); matched = true; }
          else if (okawariKeywords.test(rawTranscript) || okawariKeywords.test(normalizedTranscript)) { await switchVideo(videos.p21, rawTranscript); matched = true; }
          else if (kiteKeywords.test(rawTranscript) || kiteKeywords.test(normalizedTranscript)) { await switchVideo(videos.p22, rawTranscript); matched = true; }
          else if (oideKeywords.test(rawTranscript) || oideKeywords.test(normalizedTranscript)) { await switchVideo(videos.p23, rawTranscript); matched = true; }
          else if (okiteKeywords.test(rawTranscript) || okiteKeywords.test(normalizedTranscript)) { await switchVideo(videos.p24, rawTranscript); matched = true; }
          else if (hashiruKeywords.test(rawTranscript) || hashiruKeywords.test(normalizedTranscript)) { await switchVideo(videos.p25, rawTranscript); matched = true; }
          else if (jumpKeywords.test(rawTranscript) || jumpKeywords.test(normalizedTranscript)) { await switchVideo(videos.p26, rawTranscript); matched = true; }
          else if (sugoiKeywords.test(rawTranscript) || sugoiKeywords.test(normalizedTranscript) ||
            rikouKeywords.test(rawTranscript) || rikouKeywords.test(normalizedTranscript) ||
            tanoshiiKeywords.test(rawTranscript) || tanoshiiKeywords.test(normalizedTranscript) ||
            iiKeywords.test(rawTranscript) || iiKeywords.test(normalizedTranscript) ||
            iineKeywords.test(rawTranscript) || iineKeywords.test(normalizedTranscript) ||
            genkiKeywords.test(rawTranscript) || genkiKeywords.test(normalizedTranscript) ||
            gomenKeywords.test(rawTranscript) || gomenKeywords.test(normalizedTranscript) ||
            sukiKeywords.test(rawTranscript) || sukiKeywords.test(normalizedTranscript) ||
            arigatoKeywords.test(rawTranscript) || arigatoKeywords.test(normalizedTranscript)) { await switchVideo(videos.p4, rawTranscript); matched = true; }
          else if (sanpoKeywords.test(rawTranscript) || sanpoKeywords.test(normalizedTranscript) ||
            oyatsuKeywords.test(rawTranscript) || oyatsuKeywords.test(normalizedTranscript) ||
            dekakeKeywords.test(rawTranscript) || dekakeKeywords.test(normalizedTranscript)) { await switchVideo(videos.p12, rawTranscript); matched = true; }
          else if (chuKeywords.test(rawTranscript) || chuKeywords.test(normalizedTranscript)) { await switchVideo(videos.p5, rawTranscript); matched = true; }
          else if (douzoKeywords.test(rawTranscript) || douzoKeywords.test(normalizedTranscript)) { await switchVideo(videos.p7, rawTranscript); matched = true; }
          else if (choudaiKeywords.test(rawTranscript) || choudaiKeywords.test(normalizedTranscript)) { await switchVideo(videos.p8, rawTranscript); matched = true; }
          else if (kamatteKeywords.test(rawTranscript) || kamatteKeywords.test(normalizedTranscript)) { await switchVideo(videos.p6, rawTranscript); matched = true; }
          else if (ikunoKeywords.test(rawTranscript) || ikunoKeywords.test(normalizedTranscript)) { await switchVideo(videos.p11, rawTranscript); matched = true; }
          else if (doushimasuKeywords.test(rawTranscript) || doushimasuKeywords.test(normalizedTranscript)) {
            p4Img.style.display = "block";
            setTimeout(() => { p4Img.style.display = "none"; switchVideo(videos.p10); }, 1200);
            matched = true;
          }

          if (!matched && isP10Visible) {
            p2Img.style.display = "block";
            setTimeout(() => { p2Img.style.display = "none"; }, 1200);
            matched = true;
          }
        }
      };

      recognition.onend = () => { if (isListening) setTimeout(() => recognition.start(), 500); };
    }
    initRecognition();

    function startRecognitionRetry() {
      if (!recognition) return;
      try { recognition.start(); } catch (e) {}
      if (recognitionRetryInterval) clearInterval(recognitionRetryInterval);
      recognitionRetryInterval = setInterval(() => {
        if (isListening && videos.p10.style.display === "block") {
          try { recognition.start(); } catch (e) {}
        }
      }, 1500);
    }

    btn.addEventListener("click", () => {
      isListening = true;
      btn.classList.add("hidden");
      startRecognitionRetry();
    });

    document.addEventListener('dblclick', () => {
      const elem = document.documentElement;
      if (!document.fullscreenElement) elem.requestFullscreen?.();
      else document.exitFullscreen?.();
    });

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(e => console.error(e));
      });
    }
  </script>

</body>
</html>