<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ポルテ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background-color: black; }
    /* 2つのプレイヤーを完全に重ねて配置 */
    .v {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      max-width: 100vw; max-height: 100vh; object-fit: contain;
      opacity: 0; z-index: 1;
    }
    .active { opacity: 1; z-index: 2; }
    .footer { position: absolute; top: 10%; width: 100%; text-align: center; z-index: 10; }
    button { font-size: 1.2em; padding: 15px 25px; border-radius: 10px; background: rgba(0,0,0,0.7); color: white; border: 2px solid white; }
    #static-image, #p2-image, #p4-image { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 100vw; max-height: 100vh; z-index: 5; }
    #p2-image, #p4-image { display: none; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <img id="static-image" src="porte1.png">
  <img id="p2-image" src="porte2.png">
  <img id="p4-image" src="porte4.png">
  
  <video id="v1" class="v" playsinline muted></video>
  <video id="v2" class="v" playsinline muted></video>

  <div class="footer">
    <button id="start-btn">▶ ポルテ おこしてね</button>
  </div>

  <script>
    const btn = document.getElementById("start-btn");
    const staticImg = document.getElementById("static-image");
    const p2Img = document.getElementById("p2-image");
    const p4Img = document.getElementById("p4-image");
    const players = [document.getElementById("v1"), document.getElementById("v2")];
    
    let activeIdx = 0;
    let currentKey = "";
    let waitingKeywords = true;

    const videoFiles = {
      p1: "p1.mp4", p1rev: "p1rev.mp4", p2: "p2.mp4", p3: "p3.mp4",
      p4: "p4.mp4", p5: "p5.mp4", p6: "p6.mp4", p7: "p7.mp4",
      p8: "p8.mp4", p9: "p9.mp4", p10: "p10.mp4", p11: "p11.mp4",
      p12: "p12.mp4", p13: "p13.mp4", p14: "p14.mp4", p15: "p15.mp4",
      p16: "p16.mp4", p17: "p17.mp4", p18: "p18.mp4", p19: "p19.mp4",
      p20: "p20.mp4", p21: "p21.mp4", p22: "p22.mp4", p23: "p23.mp4",
      p24: "p24.mp4", p25: "p25.mp4", p26: "p26.mp4"
    };

    async function switchVideo(key) {
      if (!videoFiles[key] || (key === currentKey && key === "p10")) return;
      
      const nextIdx = (activeIdx + 1) % 2;
      const curP = players[activeIdx];
      const nxtP = players[nextIdx];

      currentKey = key;

      // 1. 次の動画をセット
      nxtP.src = videoFiles[key];
      nxtP.muted = !(key === "p2" || key === "p3");
      nxtP.loop = (key === "p10");

      // 2. 再生準備ができたらすぐに切り替える
      nxtP.onplaying = () => {
        nxtP.onplaying = null;
        nxtP.classList.add("active");
        curP.classList.remove("active");
        staticImg.classList.add("hidden");
        p2Img.style.display = "none";
        p4Img.style.display = "none";
        // 前の動画を止めるだけで、srcは消さない（メモリが許す限り）
        curP.pause();
      };

      try {
        await nxtP.play();
      } catch (e) {
        // Androidの気まぐれ対策：エラーが出たらもう一度play
        nxtP.play();
      }
      activeIdx = nextIdx;
    }

    players.forEach(p => {
      p.onended = () => {
        if (currentKey === "p1rev") {
          p.classList.remove("active");
          staticImg.classList.remove("hidden");
          waitingKeywords = true;
          currentKey = "";
        } else if (currentKey !== "p10" && currentKey !== "") {
          switchVideo("p10");
        }
      };
    });

    function initRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = 'ja-JP';
      recognition.continuous = true;

      // キーワード分岐（軽量化のため正規表現を統合）
      const k1 = /ぽるて|ポルテ|ぽーちゃん|ぽおちゃん|ぽうちゃん|ポーちゃん|おーちゃん|フォーちゃん|こうちゃん|父ちゃん|ふぉるて|フォルテ|来れて|これて|取れて|とれて|降りて|おりて|ポチャン|ぽちゃん/i;
      const k_ote = /おて|お手|大手|おては|お手は|大手は/i;
      const k_bye = /またね|おやすみ|じゃあね|じゃーね/i;
      const k_p3 = /返事|へんじ|お返事|おへんじ/i;
      const k_p2 = /もう一回|もういっかい|もう1回/i;
      const k_p13 = /かわいい|可愛い/i;
      const k_p14 = /なかよし|仲良し/i;
      const k_p15 = /どうした|どうしたの/i;
      const k_p16 = /だめ|ダメ|駄目/i;
      const k_p17 = /おしっこ|オシッコ/i;
      const k_p18 = /みず|水|おみず|お水/i;
      const k_p19 = /うんち|ウンチ/i;
      const k_p20 = /だっこ|ダッコ|抱っこ/i;
      const k_p21 = /おかわり/i;
      const k_p22 = /きて|来て|着て/i;
      const k_p23 = /おいで/i;
      const k_p24 = /おきて/i;
      const k_p25 = /はしる|走る/i;
      const k_p26 = /じゃんぷ|ジャンプ/i;
      const k_p4 = /すごい|凄い|りこう|利口|お利口|おりこう|たのしい|楽しい|楽しかったね|おいしい|美味しい|いいね|イイネー|いいねー|いいねえ|イイねえ|イイね|元気|げんき|ゲンキ|ごめん|ゴメン|ごめんよ|ゴメンよ|好き|すき|スキ|ありがとう|ありがと/i;
      const k_p12 = /さんぽ|散歩|お散歩|おさんぽ|おやつ|でかけ|出かけ|おでかけ|お出かけ/i;
      const k_p5 = /ちゅう|ちゅー|チュー|チュ|注|中|おはよう|おはよー/i;
      const k_p7 = /どうぞ|食べて|たべて/i;
      const k_p8 = /ちょうだい|頂戴/i;
      const k_p6 = /かまって|構って|あそんで|遊んで|あそぶの|遊ぶの/i;
      const k_p11 = /いくの|行くの|たべるの|食べるの|食べんの|たべんの|いきたい|行きたい|食べたい|たべたい/i;
      const k_doushimasu = /どうしますか|どおしますか|どーしますか/i;

      recognition.onresult = (event) => {
        const text = event.results[event.results.length - 1][0].transcript;
        let matched = false;

        if (waitingKeywords) {
          if (k1.test(text)) { switchVideo("p1"); waitingKeywords = false; matched = true; }
        } else {
          if (k1.test(text)) { switchVideo("p3"); matched = true; }
          else if (k_ote.test(text)) { switchVideo("p9"); matched = true; }
          else if (k_bye.test(text)) { switchVideo("p1rev"); matched = true; }
          else if (k_p3.test(text)) { switchVideo("p3"); matched = true; }
          else if (k_p2.test(text)) { switchVideo("p2"); matched = true; }
          else if (k_p13.test(text)) { switchVideo("p13"); matched = true; }
          else if (k_p14.test(text)) { switchVideo("p14"); matched = true; }
          else if (k_p15.test(text)) { switchVideo("p15"); matched = true; }
          else if (k_p16.test(text)) { switchVideo("p16"); matched = true; }
          else if (k_p17.test(text)) { switchVideo("p17"); matched = true; }
          else if (k_p18.test(text)) { switchVideo("p18"); matched = true; }
          else if (k_p19.test(text)) { switchVideo("p19"); matched = true; }
          else if (k_p20.test(text)) { switchVideo("p20"); matched = true; }
          else if (k_p21.test(text)) { switchVideo("p21"); matched = true; }
          else if (k_p22.test(text)) { switchVideo("p22"); matched = true; }
          else if (k_p23.test(text)) { switchVideo("p23"); matched = true; }
          else if (k_p24.test(text)) { switchVideo("p24"); matched = true; }
          else if (k_p25.test(text)) { switchVideo("p25"); matched = true; }
          else if (k_p26.test(text)) { switchVideo("p26"); matched = true; }
          else if (k_p4.test(text)) { switchVideo("p4"); matched = true; }
          else if (k_p12.test(text)) { switchVideo("p12"); matched = true; }
          else if (k_p5.test(text)) { switchVideo("p5"); matched = true; }
          else if (k_p7.test(text)) { switchVideo("p7"); matched = true; }
          else if (k_p8.test(text)) { switchVideo("p8"); matched = true; }
          else if (k_p6.test(text)) { switchVideo("p6"); matched = true; }
          else if (k_p11.test(text)) { switchVideo("p11"); matched = true; }
          else if (k_doushimasu.test(text)) {
            p4Img.style.display = "block";
            setTimeout(() => { p4Img.style.display = "none"; switchVideo("p10"); }, 1200);
            matched = true;
          }
          if (!matched && currentKey === "p10") {
            p2Img.style.display = "block";
            setTimeout(() => { p2Img.style.display = "none"; }, 1200);
          }
        }
      };
      recognition.onend = () => { recognition.start(); };
      recognition.start();
    }

    btn.addEventListener("click", () => {
      btn.classList.add("hidden");
      // Android: 最初のタップで全プレイヤーの音声を有効化
      players.forEach(p => { p.play().then(() => p.pause()); });
      initRecognition();
    });
  </script>
</body>
</html>